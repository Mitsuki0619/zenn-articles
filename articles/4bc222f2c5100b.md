---
title: "[Next.js] ServerActionsã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‡ºã—ãŸã„" # è¨˜äº‹ã®ã‚¿ã‚¤ãƒˆãƒ«
emoji: "ğŸ“¸" # ã‚¢ã‚¤ã‚­ãƒ£ãƒƒãƒã¨ã—ã¦ä½¿ã‚ã‚Œã‚‹çµµæ–‡å­—ï¼ˆ1æ–‡å­—ã ã‘ï¼‰
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢è¨˜äº‹
topics: ["Next.js", "React", "TypeScript", "AppRouter", "serveractions"] # ã‚¿ã‚°ã€‚["markdown", "rust", "aws"]ã®ã‚ˆã†ã«æŒ‡å®šã™ã‚‹
published: true # å…¬é–‹è¨­å®šï¼ˆfalseã«ã™ã‚‹ã¨ä¸‹æ›¸ãï¼‰
---

# ã‚„ã‚ŠãŸã„ã“ã¨

ã“ã®ç”»åƒã®ã‚ˆã†ã«ã€Server Actions ã§ãªã«ã‹ã—ã‚‰ã®å‡¦ç†ãŒå®Œäº†ã—ãŸã¨ãã¨ã‹ã«ç”»é¢ä¸Šã«ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãŸã„ã‚±ãƒ¼ã‚¹ã‚’ Next.jsï¼ˆApp Routerï¼‰ã§ã‚„ã£ã¦ã¿ã¾ã™ã€‚
![](https://storage.googleapis.com/zenn-user-upload/6c561d07b2c8-20250301.png)

# æ¦‚è¦

ã‚„ã‚Šæ–¹ã‚’ã–ã£ãã‚Šèª¬æ˜ã™ã‚‹ã¨ã€ã‚µãƒ¼ãƒãƒ¼å´ã§ Cookie ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒƒãƒˆã—ã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ useSyncExternalStore ã‚’ä½¿ã£ã¦ Cookie ã‚’ç›£è¦–ã—ã¤ã¤å¤‰åŒ–ãŒã‚ã‚Œã°ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼ã‚’ç™ºç«ã™ã‚‹ã¨ã„ã£ãŸæµã‚Œã§ã™ã€‚

## Cookie ã‚’ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°ã‚’ä½œã‚‹

å¼•æ•°ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã® UI ã«è¡¨ç¤ºã™ã‚‹å€¤ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ç¨®é¡ç­‰ï¼‰ã‚’å—ã‘å–ã‚Šã€JSON æ–‡å­—åˆ—ã«å¤‰æ›ã—ã€Next.js ã® cookies é–¢æ•°ã‚’ä½¿ã£ã¦ã‚»ãƒƒãƒˆã—ã¦ã„ãã¾ã™ã€‚
ã¨ã‚Šã‚ãˆãšæœ¬è¨˜äº‹ã§ã¯ title ã¨ description ã‚’å—ã‘å–ã‚‹ã¨ã—ã¾ã™ã€‚

```typescript
"use server";

import { cookies } from "next/headers";

export async function flash(content: { title: string; description?: string }) {
  const parsedFlashContent = JSON.stringify({
    ...content,
    key: crypto.randomUUID(),
  });

  (await cookies()).set("flash", parsedFlashContent, { maxAge: 1 });
}
```

:::message
**ãªãœ UUID ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã®ã‹**
UUID ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã“ã¨ã«é•å’Œæ„ŸãŒã‚ã‚‹ã‹ã¨æ€ã„ã¾ã™ãŒã€ã“ã‚Œã¯ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ¸¡ã‚Š useEffect ã§ç™ºç«ã™ã‚‹éš›ã€åŒã˜å†…å®¹ã®ãƒ‡ãƒ¼ã‚¿ãŒé€£ç¶šã™ã‚‹ã¨ useEffect ã®ä¾å­˜é…åˆ—ã«å¤‰åŒ–ãŒãªã„åˆ¤å®šã¨ãªã‚Šã€æœ€åˆã®ä¸€åº¦ã—ã‹ç™ºç«ã—ãªã„ã¨ã„ã†ã‚±ãƒ¼ã‚¹ã‚’è€ƒæ…®ã—ãŸçµæœã«ãªã‚Šã¾ã™ã€‚
ã—ãŸãŒã£ã¦ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚­ãƒ¼ã¨ã—ã¦ UUID ã‚’æ¸¡ã—ã€useEffect ãŒå¤‰æ›´ã‚’æ¤œçŸ¥ã§ãã‚‹ã‚ˆã†å·¥å¤«ã—ã¦ã„ã¾ã™ã€‚
:::

ã“ã‚Œã‚’ ServerActions å†…ã§å‘¼ã³å‡ºã›ã°ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã—ã¦ã„ãã¾ã™ã€‚

## Cookie ã¨çŠ¶æ…‹ã‚’åŒæœŸã™ã‚‹ãŸã‚ã®ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œã‚‹

Cookie ã®çŠ¶æ…‹ã‚’ç›£è¦–ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯ã‚’ä½œã‚Šã¾ã™ã€‚
ã‚­ãƒ¼ã¨ãªã‚‹ã®ã¯ useSyncExternalStore ã¨ã„ã† React ã®ãƒ“ãƒ«ãƒˆã‚¤ãƒ³ãƒ•ãƒƒã‚¯ã§ã™ã€‚
https://ja.react.dev/reference/react/useSyncExternalStore

Cookie ã¯ React ã®å¤–å´ã®ã‚¹ãƒˆã‚¢ã§ã‚ã‚Šã€ãã®ã‚¹ãƒˆã‚¢ã®çŠ¶æ…‹ã‚’ç›£è¦–ã—ãŸã„ã®ã§ã¾ã•ã—ãã“ã®ãƒ•ãƒƒã‚¯ã®ä½¿ã„é“ã‹ã¨æ€ã„ã¾ã™ã€‚

```typescript
import { useSyncExternalStore } from "react";

function subscribe(callback: () => void) {
  const observer = new MutationObserver(callback);
  observer.observe(document, {
    subtree: true,
    childList: true,
    attributes: true,
  });
  return () => observer.disconnect();
}

function getServerSideSnapshot() {
  return undefined;
}

function getCookieValue(name: string) {
  const cookies = document.cookie
    .split("; ")
    .reduce<Record<string, string>>((acc, cookie) => {
      const [key, value] = cookie.split("=");
      acc[key] = value;
      return acc;
    }, {});
  return cookies[name] || "";
}

export function useCookie(cookieName: string) {
  return useSyncExternalStore(
    subscribe,
    () => getCookieValue(cookieName),
    getServerSideSnapshot
  );
}
```

ã¾ãšã¯ useSyncExternalStore ã«å¿…è¦ãªå¤–éƒ¨ã‚¹ãƒˆã‚¢ã®ã‚µãƒ–ã‚¹ã‚¯ãƒ©ã‚¤ãƒ–é–¢æ•°ã§ã™ãŒã€MutationOberver ã¨ã„ã†ã‚¯ãƒ©ã‚¹ã‚’ä½¿ã£ã¦ document ã‚’ç›£è¦–ã—ã¾ã™ã€‚
document ã«å¤‰åŒ–ãŒã‚ã‚Œã° getCookieValue ãŒç™ºç«ã™ã‚‹ã¨ã„ã†æµã‚Œã§ã™ã­ã€‚

æ¬¡ã«ãã® getCookieValue ã§ã™ãŒã€document.cookie ã¯å…¨ã¦ã® Cookie ã‚’ã¨ã£ã¦ãã‚‹ã®ã¨ã€Cookie ã¯";"ã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã‚‹æ–‡å­—åˆ—ã§ã‚ã‚‹ãŸã‚ã€split(";")ã§ Cookie ã‚’é…åˆ—ã«ã—ã¤ã¤ã€reduce ã§ key ã¨ value ã®å½¢ã«å¤‰æ›ã—ã€æ‰±ã„ã‚„ã™ãã—ã¦ãŠãã¾ã™ã€‚

ã¡ãªã¿ã«ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯ Cookie ã‚’å–å¾—ã§ããªã„ãŸã‚ getServerSideSnapshot ã§ã¯ undefined ã‚’è¿”ã™ã¨ã—ã¾ã™ã€‚

ã“ã‚Œã‚‰ã‚’ useSyncExternalStore ã«æ¸¡ã—ã€Cookie ã‚’ç›£è¦–ã™ã‚‹ useCookie ã‚’ä½œã‚Šã¾ã™ã€‚

## useFlash

ã‚µãƒ¼ãƒãƒ¼å´ã§ã¯"flash"ã¨ã„ã†ã‚­ãƒ¼ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã®ã§ã€useCookie ã«"flash"ã¨ã„ã†æ–‡å­—åˆ—ã‚’æ¸¡ã—ã¦ Cookie ã‹ã‚‰ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–ã‚Šå‡ºã—ã¾ã—ã‚‡ã†ã€‚

```typescript
import { useCookie } from "@/hooks/use-cookie";
import { z } from "zod";

const flashContentSchema = z.object({
  title: z.string(),
  description: z.string().optional(),
  key: z.string(),
});

export type FlashContent = z.infer<typeof flashContentSchema>;

export function useFlash() {
  const cookieValueJson = useCookie("flash");
  if (!cookieValueJson) return undefined;
  const decodedStr = decodeURIComponent(cookieValueJson);
  const parsedCookieValue = JSON.parse(decodedStr);
  const { data } = flashContentSchema.safeParse(parsedCookieValue);
  return data;
}
```

:::message
zod ãŒç™»å ´ã—ã¦ã„ã¾ã™ãŒã€ã“ã‚Œã¯ JSON ã®ãƒ‘ãƒ¼ã‚¹ã‚’å …å®‰å…¨ã«è¡Œã†ãŸã‚ã®ã‚‚ã®ãªã®ã§ä¸è¦ã§ã‚ã‚Œã°ãƒ¦ãƒ¼ã‚¶ãƒ¼å®šç¾©å‹ã‚¬ãƒ¼ãƒ‰ã‚„å‹ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚‚å¯¾å¿œã§ãã¾ã™ã€‚
:::

useCookie ã«"flash"ã‚’æ¸¡ã—ã€"flash"ã¨ã„ã†ã‚­ãƒ¼ã® Cookie ã®å€¤ã‚’ç›£è¦–ã—ã¾ã™ã€‚
ã¾ãŸã€ã‚µãƒ¼ãƒãƒ¼å´ã§ JSON æ–‡å­—åˆ—ã«ã—ã¦ Cookie ã«ã‚»ãƒƒãƒˆã—ã¦ã„ã‚‹ã®ã§ã€ã“ã“ã§ãƒ‘ãƒ¼ã‚¹ã—ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«æˆ»ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
ãŸã ã€Cookie ã« JSON ã‚’ã‚»ãƒƒãƒˆã—ãŸæ™‚ç‚¹ã§ãã® JSON æ–‡å­—åˆ—ã¯ URL ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã•ã‚Œã‚‹ã®ã§ã€å…ˆã« decodeURIComponent ã§ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ãŸå¾Œã« JSON ãƒ‘ãƒ¼ã‚¹ã—ã¾ã™ã€‚

## ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç™ºç«ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½œã‚‹

å…ˆã»ã©ä½œã£ãŸ useFlash ã‚’å‘¼ã³å‡ºã—ã€Cookie ã«ã‚»ãƒƒãƒˆã•ã‚Œã‚‹ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—ã—ã¾ã™ã€‚
useEffect å†…ã§ã€ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒã‚ã‚Œã°ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼ã‚’ç™ºç«ã™ã‚‹å‡¦ç†ã‚’æ›¸ãã¾ã™ã€‚
â€»ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼ã¯ shadcn ui ã® API ã‚’ä½¿ã£ã¦ã„ã¾ã™ã€‚

```typescript
"use client";

import { useFlash } from "@/hooks/use-flash";
import { toast } from "@/hooks/use-toast";
import { useEffect } from "react";

export function FlashToaster() {
  const flashContent = useFlash();

  useEffect(() => {
    if (flashContent?.key) {
      toast({
        title: flashContent.title,
        description: flashContent.description,
      });
    }
  }, [flashContent?.title, flashContent?.key, flashContent?.description]);
  return null;
}
```

ã“ã‚Œã‚’ãƒ«ãƒ¼ãƒˆã® layout.tsx ã«é…ç½®ã—ã¾ã™ã€‚

```typescript
import { FlashToaster } from "@/components/functional/FlashToaster";
import { Toaster } from "@/components/ui/toaster";
import type { ReactNode } from "react";

export default function Layout({ children }: { children: ReactNode }) {
  return (
    <html lang="ja">
      <body>
        <main>{children}</main>
        <FlashToaster />
        <Toaster />
      </body>
    </html>
  );
}
```

ã“ã‚Œã§å®Ÿè£…ã¯çµ‚ã‚ã‚Šã§ã™ã€‚
ã‚ã¨ã¯ä¸‹è¨˜ã®ã‚ˆã†ã« ServerActions å†…ã§ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚’ç™ºç«ã™ã‚Œã°ãƒˆãƒ¼ã‚¹ã‚¿ãƒ¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚

```typeScript
await flash({ title: "äºˆå®šãŒæ›´æ–°ã•ã‚Œã¾ã—ãŸï¼" });
```

## åˆ¥è§£ï¼Ÿ

å®Ÿã¯å…ƒã€… useSyncExternalStore ã®ä»£ã‚ã‚Šã«ã€Next.js ã® cookie ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ Cookie ã‚’å–å¾—ã™ã‚‹ã‚„ã‚Šæ–¹ã‚’è€ƒãˆã¦ã¾ã—ãŸã€‚
ãã‚Œã§ã‚‚ç™ºç«ã™ã‚‹ã«ã¯ã™ã‚‹ã®ã§ã™ãŒã€Next.js ã® cookie ã‚’ä½¿ã†ã¨ãã®ãƒ«ãƒ¼ãƒˆã¯ Dynamic Rendering ã«ãªã£ã¦ã—ã¾ã†ã‚“ã§ã™ã‚ˆã­ã€‚ãƒ«ãƒ¼ãƒˆã® layout.tsx ã« cookie ã®å‡¦ç†ã‚’å«ã‚“ã ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ç½®ã„ã¦ã—ã¾ã†ã¨çµæœçš„ã«å…¨ãƒ«ãƒ¼ãƒˆãŒ Dynamic Rendering ã«ãªã£ã¦ã—ã¾ã„ã€Static Rendering ã‚„ PPR ã¨ã„ã£ãŸé¸æŠè‚¢ãŒæ¶ˆãˆã¦ã—ã¾ã†ã†ãˆã€Cookie ã‚’å–å¾—ã—ã€SSR ãŒå®Œäº†ã™ã‚‹ã¾ã§ç”»é¢ãŒè¡¨ç¤ºã•ã‚Œãªã„ãŸã‚å…¨ä½“çš„ã«ãƒšãƒ¼ã‚¸é·ç§»ãŒã‚‚ã£ã•ã‚Šã—ã¦ UX ãŒæ‚ªããªã£ã¦ã—ã¾ã„ã¾ã™ã€‚
çµæœã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ã® Cookie ç›£è¦–ã¨ã„ã†é¸æŠã«è‡³ã‚Šã¾ã—ãŸã€‚
ä»–ã«è‰¯ã„æ–¹æ³•ãŒã”ã–ã„ã¾ã—ãŸã‚‰ã‚³ãƒ¡ãƒ³ãƒˆã„ãŸã ã‘ã¾ã™ã¨å¹¸ã„ã§ã™ã€‚
